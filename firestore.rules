/**
 * @file firestore.rules
 * @description Firestore Security Rules for the ViaGraph application.
 *
 * @section Core Philosophy
 * This ruleset establishes a clear separation between standard users and administrators.
 * The default security posture is to deny all access, granting permissions explicitly.
 * Standard users (including anonymous ones) have read-only access to public route data.
 * Administrators are granted write privileges over route data. User profile data is strictly private to the owner.
 *
 * @section Data Structure
 * The data is organized into distinct top-level collections for clear separation of concerns and simple, performant rules:
 * - /users/{userId}: Stores private user profile information.
 * - /roles_admin/{userId}: A simple collection where the existence of a document grants a user administrative privileges.
 * - /locations/{locationId}: Contains all physical locations/stops. Publicly readable, admin-writable.
 * - /routes/{routeName}: Contains all official jeepney lines. Publicly readable, admin-writable.
 * - /route_segments/{segmentId}: Contains the graph edges connecting locations. Publicly readable, admin-writable.
 *
 * @section Key Security Decisions
 * - Admin Role Management: A user is considered an admin if a document with their UID exists in the `/roles_admin` collection. This "existence-over-content" pattern is fast and secure.
 * - Public Data: All transportation data (`locations`, `routes`, `route_segments`) is publicly readable for pathfinding.
 * - User Privacy: Users can only read and write their own document in the `/users` collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the requesting user has admin privileges.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for user profile documents.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if false;
    }

    /**
     * @description Rules for the admin role collection.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Publicly readable location data. Writable only by admins.
     */
    match /locations/{locationId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Publicly readable route data. Writable only by admins.
     */
    match /routes/{routeName} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Publicly readable route segment data. Writable only by admins.
     */
    match /route_segments/{segmentId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}
